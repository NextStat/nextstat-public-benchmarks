name: Weekly Snapshot (GPU)

on:
  schedule:
    # Mondays 05:00 UTC (stagger after CPU)
    - cron: "0 5 * * 1"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  weekly-gpu:
    runs-on: [self-hosted, Linux, X64, gpu]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install harness deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r env/python/requirements.txt

      - name: Install ML deps (JAX CUDA)
        run: |
          set -euo pipefail
          python -m pip install -r env/python/requirements-ml-jax-cuda12.txt || true

      - name: Compute snapshot id
        run: |
          set -euo pipefail
          d="$(date -u +%Y-%m-%d)"
          echo "SNAPSHOT_ID=snapshot-weekly-gpu-${d}-run${GITHUB_RUN_ID}" >> "${GITHUB_ENV}"

      - name: Get pinned NextStat wheel (local path)
        env:
          NEXTSTAT_WHEEL_PATH: ${{ vars.NEXTSTAT_WEEKLY_GPU_WHEEL_PATH }}
          NEXTSTAT_WHEEL_SHA256: ${{ vars.NEXTSTAT_WEEKLY_GPU_WHEEL_SHA256 }}
        run: |
          set -euo pipefail
          if [ -z "${NEXTSTAT_WHEEL_PATH}" ]; then
            echo "Missing repo var: NEXTSTAT_WEEKLY_GPU_WHEEL_PATH" >&2
            exit 2
          fi
          if [ -z "${NEXTSTAT_WHEEL_SHA256}" ]; then
            echo "Missing repo var: NEXTSTAT_WEEKLY_GPU_WHEEL_SHA256" >&2
            exit 2
          fi
          if [ ! -f "${NEXTSTAT_WHEEL_PATH}" ]; then
            echo "Wheel file not found: ${NEXTSTAT_WHEEL_PATH}" >&2
            exit 2
          fi
          mkdir -p tmp
          WHEEL_NAME="$(basename "${NEXTSTAT_WHEEL_PATH}")"
          cp -f "${NEXTSTAT_WHEEL_PATH}" "tmp/${WHEEL_NAME}"
          echo "${NEXTSTAT_WHEEL_SHA256}  tmp/${WHEEL_NAME}" | sha256sum -c -
          echo "NEXTSTAT_WHEEL_NAME=${WHEEL_NAME}" >> "${GITHUB_ENV}"

      - name: Install NextStat wheel
        run: |
          set -euo pipefail
          python -m pip install "tmp/${NEXTSTAT_WHEEL_NAME}"

      - name: "GPU info (best-effort)"
        run: |
          set -euo pipefail
          if command -v nvidia-smi >/dev/null 2>&1; then
            nvidia-smi || true
            nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv,noheader || true
          else
            echo "NOTE: nvidia-smi not found on runner."
          fi

      - name: Run snapshot (ML only, GPU)
        run: |
          set -euo pipefail
          python scripts/publish_snapshot.py \
            --snapshot-id "${SNAPSHOT_ID}" \
            --deterministic \
            --suite "weekly-gpu" \
            --nextstat-wheel "tmp/${NEXTSTAT_WHEEL_NAME}" \
            --ml \
            --ml-backends numpy,jax_jit_gpu

      - name: Update snapshot registry (commit-backed)
        run: |
          set -euo pipefail
          python scripts/update_snapshot_registry.py \
            --snapshot-dir "manifests/snapshots/${SNAPSHOT_ID}" \
            --registry "manifests/registry/snapshot_registry.json"

          git status --porcelain
          git add manifests/registry/snapshot_registry.json
          if git diff --cached --quiet; then
            echo "No registry changes to commit."
            exit 0
          fi
          git config user.name "nextstat-bench-bot"
          git config user.email "benchmarks-bot@users.noreply.github.com"
          git commit -m "registry: add ${SNAPSHOT_ID}"
          git push

      - name: Package snapshot (DOI-ready archive)
        run: |
          set -euo pipefail
          python zenodo/package_snapshot.py \
            --snapshot-dir "manifests/snapshots/${SNAPSHOT_ID}" \
            --out-dir tmp/zenodo_out

      - name: Upload snapshot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-${{ env.SNAPSHOT_ID }}
          path: manifests/snapshots/${{ env.SNAPSHOT_ID }}/

      - name: Upload DOI package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doi-package-${{ env.SNAPSHOT_ID }}
          path: tmp/zenodo_out/

